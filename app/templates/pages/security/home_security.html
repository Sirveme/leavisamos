{% extends "base.html" %}

<!-- AQUÍ LE DECIMOS: "En esta página, usa todo el ancho" -->
{% block container_width %}max-w-full lg:max-w-[95%]{% endblock %}

{% block content %}

<!-- Contenedor Principal: Altura fija de pantalla, sin scroll en el body -->
<div class="flex flex-col h-[calc(100vh-2rem)] gap-4 overflow-hidden">

    <!-- 1. CABECERA CENTINELA (Modificada con Nombre) -->
    <div id="status-box" class="bg-slate-800 border border-slate-600 p-3 rounded-xl flex items-center justify-between transition-colors duration-500 shrink-0 shadow-md">
        
        <!-- Izquierda: Estado -->
        <div class="flex items-center gap-3">
            <div class="p-2 bg-slate-900 rounded-lg">
                <i class="ph ph-shield-check text-2xl text-indigo-400"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-200 leading-none">CENTINELA</h1>
                <!-- Aquí mostramos quién está de turno -->
                <p class="text-[10px] text-slate-400 mt-1 flex items-center gap-1">
                    <span id="status-text">Monitoreo Activo</span>
                    <span class="text-slate-600">|</span>
                    <!-- FIX: user.user.name -->
                    <span class="text-indigo-300">{{ user.user.name }}</span>
                </p>
            </div>
        </div>

        <!-- Centro: Selector de Edificio (Solo si tiene > 1) -->
        {% if profiles|length > 1 %}
        <div class="relative group hidden md:block">
            <button class="flex items-center gap-2 text-xs font-bold text-slate-300 bg-black/30 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-slate-500">
                {{ user.organization.name }}
                <i class="ph ph-caret-down"></i>
            </button>
            
            <!-- Dropdown -->
            <div class="absolute top-full right-0 mt-0 pt-2 w-64 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl overflow-hidden hidden group-hover:block z-50">
                {% for p in profiles %}
                    <a href="/auth/switch/{{ p.id }}" class="block px-4 py-3 text-xs text-slate-300 hover:bg-slate-800 border-b border-slate-800">
                        {{ p.organization.name }}
                    </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Derecha: Botón Atender -->
        <button id="btn-silenciar" onclick="silenciarAlarma()" class="hidden bg-red-500 hover:bg-red-400 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg animate-pulse">
            ATENDER
        </button>
    </div>

    <!-- 2. ÁREA DE TRABAJO (Grid Responsive) -->
    <!-- overflow-hidden aquí es clave para evitar doble scroll -->
    <!-- 2. ÁREA DE TRABAJO (Responsive Real) -->
    <div class="flex-1 flex flex-col lg:flex-row gap-4 overflow-hidden min-h-0">
        
        <!-- COLUMNA IZQUIERDA: BITÁCORA -->
        <div class="h-48 lg:h-auto lg:w-1/3 bg-black rounded-xl border border-slate-800 flex flex-col overflow-hidden shadow-inner shrink-0 order-2 lg:order-1">
            
            <!-- CABECERA DE HERRAMIENTAS -->
            <div class="bg-slate-900/80 p-2 border-b border-slate-800 flex justify-between items-center backdrop-blur-md">
                <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> LIVE LOG
                </span>
                
                <!-- CONTROLES -->
                <div class="flex gap-1">
                    <!-- Zoom Text -->
                    <button onclick="changeFontSize(-1)" class="p-1 text-slate-400 hover:text-white border border-slate-700 rounded bg-black/50" title="Achicar texto">A-</button>
                    <button onclick="changeFontSize(1)" class="p-1 text-slate-400 hover:text-white border border-slate-700 rounded bg-black/50" title="Agrandar texto">A+</button>
                    
                    <!-- IA Resumen -->
                    <button onclick="playBriefing()" class="ml-2 flex items-center gap-1 px-2 text-[10px] font-bold text-indigo-300 bg-indigo-900/30 border border-indigo-500/30 rounded hover:bg-indigo-900 hover:text-white transition-colors">
                        <i class="ph ph-robot"></i> RESUMEN
                    </button>
                </div>
            </div>

            <!-- LOG (Con ID para el zoom) -->
            <div id="security-log" class="flex-1 overflow-y-auto p-3 font-mono text-xs space-y-2 transition-all">
                <!-- Logs aquí -->
            </div>
        </div>

        <!-- COLUMNA DERECHA: OPERACIONES -->
        <!-- En mobile: Ocupa el resto. En PC: W-2/3 (Más ancho) -->
        <div class="flex-1 lg:w-2/3 bg-slate-900 rounded-xl border border-slate-800 flex flex-col overflow-hidden shadow-xl order-1 lg:order-2">

            <div class="mb-4">
                <button id="btn-panico-centinela" 
                        class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-900/50 flex items-center justify-center gap-3 transition-transform active:scale-95">
                    <i class="ph ph-warning-octagon text-3xl animate-pulse"></i>
                    <span class="text-xl">ACTIVAR ALERTA GENERAL</span>
                </button>
            </div>
            
            <!-- Buscador Fijo -->
            <div class="p-4 border-b border-slate-800 bg-slate-900 z-10">
                <div class="relative max-w-2xl mx-auto"> <!-- Centrado en pantallas grandes -->
                    <i class="ph ph-magnifying-glass absolute left-4 top-3.5 text-slate-500 text-lg"></i>
                    <input type="text" name="query" 
                           class="w-full bg-black border border-slate-700 text-white rounded-xl pl-12 pr-4 py-3 text-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder-slate-600"
                           placeholder="Buscar Unidad (501) o Nombre..."
                           autocomplete="off"
                           hx-post="/centinela/search" 
                           hx-trigger="keyup changed delay:300ms" 
                           hx-target="#search-results">
                </div>
            </div>

            <!-- Resultados -->
            <div id="search-results" class="flex-1 overflow-y-auto p-4 bg-slate-950/50 relative">
                <div class="flex flex-col items-center justify-center h-full text-slate-600 opacity-50">
                    <i class="ph ph-hand-pointing text-6xl mb-4"></i>
                    <p class="text-lg">Ingrese un número de departamento</p>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Configuración JS -->
<script>
    window.APP_CONFIG = {
        wsUrl: (window.location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + window.location.host + '/ws/alerta'
    };
</script>
<script src="/static/js/pages/home_security.js"></script>

<!-- Estilos Extra para Scrollbar Horizontal -->
<style>
    .scrollbar-thin::-webkit-scrollbar { height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
</style>
{% endblock %}